openapi: 3.0.3
info:
  title: API Inventario
  version: 1.0.0
  description: >
    Microservicio encargado de la gestión de productos y tiendas. <br>
    Operaciones de creación, actualización, eliminación y consulta de productos y tiendas. <br><br>
    Autenticación vía JWT en el header: Authorization: Bearer {token}
servers:
  - url: http://localhost:3000/api
    descripcion: Local (desarrollo)
  - url: https://pulga-shop-inventario-api.onrender.com/api
    description: Cloud (producción)
tags:
  - name: Productos
    description: Gestión de productos y stock
  - name: Tiendas
    description: Gestión de tiendas
  - name: Reservas
    description: Gestión de reservas de stock (checkout)
security:
  - bearerAuth: []

paths:
  /productos:
    post:
      tags: [Productos]
      summary: Crear producto
      description: >
        Crea un nuevo producto asociado a una tienda activa. El SKU se genera automáticamente. <br>
        Campos opcionales reciben valores por defecto si no se envían.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoPost'
      responses:
        '201':
          description: Producto creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductoGet'
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                stockInvalido:
                  value:
                    message: El stock debe ser al menos 1
                    error: STOCK_INVALIDO
                precioInvalido:
                  value:
                    message: El precio debe ser al menos 1
                    error: PRECIO_INVALIDO
        '404':
          description: Tienda no existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: La tienda no existe
                error: TIENDA_NO_EXISTE
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Sesión no iniciada
                error: NO_AUTORIZADO
        '500':
          $ref: '#/components/responses/ErrorServidor'

    get:
      tags: [Productos]
      summary: Listar productos del vendedor
      description: >
        Devuelve productos activos pertenecientes a las tiendas del vendedor autenticado. <br>
        Soporta paginación y filtros por tienda y rango de precio.
      security:
        - bearerAuth: []
      parameters:
        - name: id_tienda
          in: query
          required: false
          schema:
            type: integer
          description: Filtra por ID de tienda
        - name: precio_min
          in: query
          required: false
          schema:
            type: number
          description: Precio mínimo (gte)
        - name: precio_max
          in: query
          required: false
          schema:
            type: number
          description: Precio máximo (lte)
        - name: page
          in: query
          required: false
          schema:
            type: integer
          description: Página (>=1)
        - name: take
          in: query
          required: false
          schema:
            type: integer
          description: Tamaño de página (1-30)
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [ASC, DESC]
          description: Orden por fecha_creacion
      responses:
        '200':
          description: Lista paginada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductosPaginados'
        '400':
          description: Rango inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: El precio mínimo no puede ser mayor que el precio máximo
                error: DATOS_ERRONEOS
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Sesión no iniciada
                error: NO_AUTORIZADO
        '409':
          descripcion: Conflicto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Producto con SKU 'P1-POL-ADI-ROP-NUE' no encontrado
                code: ERROR_CODES.NO_ENCONTRADO,

        '500':
          $ref: '#/components/responses/ErrorServidor'

  /productos/{sku}:
    get:
      tags: [Productos]
      summary: Obtener producto por SKU
      description: >
        Retorna un producto activo por su SKU.
      security: []
      parameters:
        - $ref: '#/components/parameters/skuParam'
      responses:
        '200':
          description: Producto encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductoGet'
        '404':
          description: No encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Producto con SKU 'ABC' no encontrado
                error: NO_ENCONTRADO
        '500':
          $ref: '#/components/responses/ErrorServidor'

    patch:
      tags: [Productos]
      summary: Actualizar producto
      description: >
        Actualiza campos del producto. Todos los campos son opcionales, se requiere al menos uno. <br>
        Validaciones de no negativo para stock y precio.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/skuParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoPatch'
      responses:
        '200':
          description: Producto actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductoGet'
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                stockNegativo:
                  value:
                    message: El stock no puede ser negativo
                    error: STOCK_INVALIDO
                precioNegativo:
                  value:
                    message: El precio no puede ser negativo
                    error: PRECIO_INVALIDO
        '404':
          description: Producto no existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: El producto con SKU ABC no existe
                error: NO_ENCONTRADO
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: No tienes permisos para actualizar este producto
                error: NO_AUTORIZADO
        '500':
          $ref: '#/components/responses/ErrorServidor'

    delete:
      tags: [Productos]
      summary: Eliminar producto
      description: >
        Marca el producto como inactivo si el vendedor es dueño y no está en una reserva activa.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/skuParam'
      responses:
        '204':
          description: Eliminado
        '404':
          description: Producto no existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: El producto con SKU ABC no existe
                error: NO_ENCONTRADO
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: No tienes permisos para eliminar este producto
                error: NO_AUTORIZADO
        '409':
          description: Producto en reserva activa
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: El producto está en una reserva activa
                error: PRODUCTO_EN_RESERVA
        '500':
          $ref: '#/components/responses/ErrorServidor'

  /tiendas:
    get:
      tags: [Tiendas]
      summary: Listar tiendas del vendedor
      description: >
        Retorna tiendas activas del vendedor autenticado con paginación.
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
          description: Página (>=1)
        - name: take
          in: query
          required: false
          schema:
            type: integer
          description: Tamaño de página (1-30)
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [ASC, DESC]
          description: Orden por fecha_creacion
      responses:
        '200':
          description: Lista paginada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TiendasPaginadas'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Sesión no iniciada
                error: NO_AUTORIZADO
        '500':
          $ref: '#/components/responses/ErrorServidor'

    post:
      tags: [Tiendas]
      summary: Crear tienda
      description: >
        Crea una tienda asociada al vendedor autenticado.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TiendaPost'
      responses:
        '201':
          description: Tienda creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TiendaGet'
        '404':
          description: Ciudad no existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "La ciudad con el ID: '99' no existe"
                error: CIUDAD_NO_EXISTE
        '409':
          description: Conflicto (nombre duplicado)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Vendedor ya tiene una tienda con el nombre: 'X'"
                error: TIENDA_YA_EXISTE
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: No tienes permisos para crear una tienda
                error: NO_AUTORIZADO
        '500':
          $ref: '#/components/responses/ErrorServidor'

  /tiendas/{id_tienda}:
    get:
      tags: [Tiendas]
      summary: Obtener tienda
      description: >
        Retorna detalles de una tienda activa.
      security: []
      parameters:
        - $ref: '#/components/parameters/id_tiendaParam'
      responses:
        '200':
          description: Tienda encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TiendaGet'
        '404':
          description: No encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Tienda no existe
                error: TIENDA_NO_ENCONTRADA
        '500':
          $ref: '#/components/responses/ErrorServidor'

    patch:
      tags: [Tiendas]
      summary: Actualizar tienda
      description: >
        Actualiza uno o más campos (mínimo 1). Campos permitidos: nombre, descripcion, direccion, telefono.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/id_tiendaParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TiendaPatch'
      responses:
        '200':
          description: Tienda actualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TiendaGet'
        '400':
          description: Cuerpo vacío
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Debe haber al menos un campo
                error: CUERPO_VACIO
        '401':
            description: No autorizado
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/Error'
                example:
                  message: No tienes permisos para editar esta tienda
                  error: NO_AUTORIZADO
        '404':
          description: No encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: Tienda no existe
                error: TIENDA_NO_ENCONTRADA
        '500':
          $ref: '#/components/responses/ErrorServidor'

  /reservas:
    post:
      tags: [Reservas]
      summary: Reservar stock para una orden (inicio de checkout)
      description: >
        Realiza una reserva temporal de stock para una orden.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservaRequest'
      responses:
        '200':
          description: Reserva creada con éxito
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservaResponse'
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: La cantidad debe ser mayor a cero
                error: DATOS_ERRONEOS
        '409':
          description: Stock insuficiente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: No hay stock suficiente de este producto
                error: STOCK_INSUFICIENTE
        '500':
          $ref: '#/components/responses/ErrorServidor'

  /reservas/{id_orden}/confirmar:
    patch:
      tags: [Reservas]
      summary: Confirmar reserva de stock tras pago exitoso
      description: >
        Confirma una reserva previamente realizada para una orden.
      security: []
      parameters:
        - $ref: '#/components/parameters/idOrden'
      responses:
        '200':
          description: Reserva confirmada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservaResponse'
        '404':
          description: Orden no encontrada o reserva expirada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: La reserva con ID 123 no fue encontrada
                error: RESERVA_NO_ENCONTRADA
        '500':
          $ref: '#/components/responses/ErrorServidor'

  /reservas/{id_orden}/cancelar:
    patch:
      tags: [Reservas]
      summary: Cancelar reserva de stock (pago fallido o timeout)
      description: >
        Cancela una reserva de stock asociada a una orden.
      security: []
      parameters:
        - $ref: '#/components/parameters/idOrden'
      responses:
        '201':
          description: Reserva cancelada, stock devuelto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservaResponse'
        '404':
          description: Orden no encontrada o reserva expirada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: La reserva con ID 123 no fue encontrada
                error: RESERVA_NO_ENCONTRADA
        '500':
          $ref: '#/components/responses/ErrorServidor'

components:
  schemas:
    ProductoGet:
      type: object
      properties:
        id_producto:
          type: integer
        id_tienda:
          type: integer
        nombre:
          type: string
        stock:
          type: integer
        precio:
          type: integer
        sku:
          type: string
        condicion:
          type: string
          enum: [NUEVO, USADO, REACONDICIONADO]
        fecha_creacion:
          type: string
          format: date-time
        marca:
          type: string
        categoria:
          type: string
          enum:
            - ELECTRÓNICA
            - ROPA
            - CALZADO
            - HOGAR
            - JUGUETES
            - DEPORTES
            - LIBROS
            - ALIMENTOS
            - BELLEZA
            - OFICINA
            - AUTOMOTRIZ
            - MASCOTAS
            - GENERAL
        descripcion:
          type: string
      required:
        - id_producto
        - id_tienda
        - nombre
        - stock
        - precio
        - sku
        - condicion
        - fecha_creacion
      example:
        id_producto: 10
        id_tienda: 3
        nombre: "Mouse Gamer"
        stock: 25
        precio: 19990
        sku: "T3-MOUSE-GAMER-GENERAL-NUEVO"
        condicion: NUEVO
        fecha_creacion: "2025-01-10T12:00:00Z"
        marca: "Genérica"
        categoria: "GENERAL"
        descripcion: "Sin descripcion"

    ProductoPost:
      type: object
      properties:
        id_tienda:
          type: integer
        nombre:
          type: string
        stock:
          type: integer
        precio:
          type: integer
        condicion:
          type: string
          enum: [NUEVO, USADO, REACONDICIONADO]
        marca:
          type: string
        categoria:
          type: string
          enum:
            - ELECTRÓNICA
            - ROPA
            - CALZADO
            - HOGAR
            - JUGUETES
            - DEPORTES
            - LIBROS
            - ALIMENTOS
            - BELLEZA
            - OFICINA
            - AUTOMOTRIZ
            - MASCOTAS
            - GENERAL
        descripcion:
          type: string
      required:
        - id_tienda
        - nombre
        - stock
        - precio
      example:
        id_tienda: 3
        nombre: "Mouse Gamer"
        stock: 25
        precio: 19990
        condicion: NUEVO
        marca: "Genérica"
        categoria: GENERAL
        descripcion: "Sin descripcion"

    ProductoPatch:
      type: object
      minProperties: 1
      properties:
        id_tienda:
          type: integer
        nombre:
          type: string
        stock:
          type: integer
        precio:
          type: integer
        condicion:
          type: string
          enum: [NUEVO, USADO, REACONDICIONADO]
        marca:
          type: string
        categoria:
          type: string
          enum:
            - ELECTRÓNICA
            - ROPA
            - CALZADO
            - HOGAR
            - JUGUETES
            - DEPORTES
            - LIBROS
            - ALIMENTOS
            - BELLEZA
            - OFICINA
            - AUTOMOTRIZ
            - MASCOTAS
            - GENERAL
        descripcion:
          type: string
      example:
        precio: 17990
        stock: 30
        marca: "MarcaX"

    ProductosPaginados:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ProductoGet'
        meta:
          type: object
          properties:
            page:
              type: integer
            take:
              type: integer
            itemCount:
              type: integer
            pageCount:
              type: integer
            hasPreviousPage:
              type: boolean
            hasNextPage:
              type: boolean
      example:
        data:
          - id_producto: 1
            id_tienda: 3
            nombre: "Mouse"
            stock: 10
            precio: 10000
            sku: "T3-MOUSE-GENERAL-NUEVO"
            condicion: NUEVO
            fecha_creacion: "2025-01-10T12:00:00Z"
            marca: "Genérica"
            categoria: GENERAL
            descripcion: "Sin descripcion"
          - id_producto: 2
            id_tienda: 3
            nombre: "Teclado"
            stock: 5
            precio: 25000
            sku: "T3-TECLADO-GENERAL-NUEVO"
            condicion: NUEVO
            fecha_creacion: "2025-01-11T12:00:00Z"
            marca: "Genérica"
            categoria: GENERAL
            descripcion: "Sin descripcion"
        meta:
          page: 1
          take: 10
          itemCount: 2
          pageCount: 1
          hasPreviousPage: false
          hasNextPage: false

    TiendaPost:
      type: object
      properties:
        nombre:
          type: string
        id_ciudad:
          type: integer
        descripcion:
          type: string
        direccion:
          type: string
        telefono:
          type: string
        online:
          type: boolean
      required:
        - nombre
        - id_ciudad
        - descripcion
        - direccion
        - telefono
        - online
      example:
        nombre: "CompuShop"
        id_ciudad: 1
        descripcion: "Tecnología y accesorios"
        direccion: "Av. Central 123"
        telefono: "912345678"
        online: true

    TiendaPatch:
      type: object
      minProperties: 1
      properties:
        nombre:
          type: string
        descripcion:
          type: string
        direccion:
          type: string
        telefono:
          type: string
      example:
        descripcion: "Nueva descripción"

    TiendaGet:
      type: object
      properties:
        id_tienda:
          type: integer
        id_vendedor:
          type: string
        nombre:
          type: string
        id_ciudad:
          type: integer
        descripcion:
          type: string
        direccion:
          type: string
        telefono:
          type: string
        fecha_creacion:
          type: string
          format: date-time
        online:
          type: boolean
      required:
        - id_tienda
        - id_vendedor
        - nombre
        - id_ciudad
        - descripcion
        - direccion
        - telefono
        - fecha_creacion
        - online
      example:
        id_tienda: 3
        id_vendedor: "456"
        nombre: "CompuShop"
        id_ciudad: 1
        descripcion: "Tecnología y accesorios"
        direccion: "Av. Central 123"
        telefono: "912345678"
        fecha_creacion: "2025-01-10T12:00:00Z"
        online: true

    TiendasPaginadas:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TiendaGet'
        meta:
          type: object
          properties:
            page:
              type: integer
            take:
              type: integer
            itemCount:
              type: integer
            pageCount:
              type: integer
            hasPreviousPage:
              type: boolean
            hasNextPage:
              type: boolean
      example:
        data:
          - id_tienda: 3
            id_vendedor: "456"
            nombre: "CompuShop"
            id_ciudad: 1
            descripcion: "Tecnología y accesorios"
            direccion: "Av. Central 123"
            telefono: "912345678"
            fecha_creacion: "2025-01-10T12:00:00Z"
            online: true
        meta:
          page: 1
          take: 10
          itemCount: 1
          pageCount: 1
          hasPreviousPage: false
          hasNextPage: false

    ReservaRequest:
      type: object
      properties:
        id_orden:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              sku:
                type: string
              cantidad_reservada:
                type: integer
        expira_en:
          type: string
          format: date-time
      required:
        - id_orden
        - items
        - expira_en

    ReservaResponse:
      type: object
      properties:
        success:
          type: boolean
        id_orden:
          type: string

    Error:
      type: object
      properties:
        message:
          type: string
        error:
          type: string
      required:
        - message
        - error
      example:
        message: direccion must be a string
        error: Bad request

  responses:
    ErrorServidor:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Ocurrió un error en el servidor
            error: ERROR_INTERNO

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    skuParam:
      name: sku
      in: path
      required: true
      description: Identificador único del producto
      schema:
        type: string
    idOrden:
      name: id_orden
      in: path
      required: true
      schema:
        type: string
      description: Identificador de la orden asociada a la reserva
    id_tiendaParam:
      name: id_tienda
      in: path
      required: true
      description: Identificador único de la tienda
      schema:
        type: integer